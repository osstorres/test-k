name: "CI/CD: App runner"

on:
  pull_request:
    types:
      - closed
    branches: [main]
    paths: ['app/**']

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        id: set-env
        run: |
          echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> $GITHUB_ENV
          echo "ECR_REPOSITORY=${{ secrets.ECR_REPOSITORY }}" >> $GITHUB_ENV
          echo "SECRET_NAME=${{ secrets.SECRET_NAME }}" >> $GITHUB_ENV
          echo "APP_RUNNER_SERVICE=${{ secrets.APP_RUNNER_SERVICE }}" >> $GITHUB_ENV
          echo "AWS_ROLE=${{ secrets.AWS_ROLE }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=production" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_ENV

      - name: Configure AWS credentials for ECR
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHub-OIDC-ECR

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get Secrets
        run: |
          mkdir -p app/secrets
          touch app/secrets/.env
          
          secrets=$(aws secretsmanager list-secrets \
            --filters Key=name,Values=${{ env.SECRET_NAME }} \
            --query 'SecretList[*].Name' \
            --output text)
          
          if [ -z "$secrets" ]; then
            echo "ERROR: No secrets found with name filter: $SECRET_NAME"
            exit 1
          fi
          
          for secret_name in $secrets; do
            aws secretsmanager get-secret-value \
              --secret-id $secret_name \
              --query SecretString \
              --output text | jq -r 'to_entries | .[] | .key + "=" + .value' >> app/secrets/.env
          done

      - name: Build and push to ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker build \
            --build-arg ENV_FILE=app/secrets/.env \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "imageTag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "repository=${ECR_REPOSITORY##*/}" >> $GITHUB_OUTPUT

      - name: Update PR with Build Status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `### üê≥ Docker Build Status - ${{ env.ENVIRONMENT }}
            #### Build Details
            | Status | Description |
            |--------|-------------|
            | üè∑Ô∏è Repository | \`${{ steps.build-image.outputs.repository }}\` |
            | üîñ Tag | \`${{ steps.build-image.outputs.imageTag }}\` |
            | üèóÔ∏è Branch | \`${process.env.GITHUB_HEAD_REF}\` |
            | üåç Environment | \`${{ env.ENVIRONMENT }}\` |
            
            #### Build Summary
            ‚úÖ Successfully built and pushed to Amazon ECR
            
            > Image is ready for deployment to App Runner
            
            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
            
      # Deployment Phase
      - name: Configure AWS credentials for App Runner
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHub-OIDC-AppRunner
          
      - name: Deploy to AWS App Runner
        id: deploy-apprunner
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          echo "Starting deployment to App Runner service: ${{ env.APP_RUNNER_SERVICE }}"
          echo "Environment: ${{ env.ENVIRONMENT }}"
          
          # Start a deployment using the latest image
          DEPLOYMENT_ID=$(aws apprunner start-deployment \
            --service-arn ${{ env.APP_RUNNER_SERVICE }} \
            --query "OperationId" \
            --output text)
          
          echo "Deployment started with ID: $DEPLOYMENT_ID"
          echo "deploymentId=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          
          # Wait for deployment to complete (optional, can be removed if it takes too long)
          echo "Waiting for deployment to complete..."
          
          # Poll for deployment status using describe-service
          MAX_ATTEMPTS=30
          ATTEMPT=0
          SLEEP_TIME=10
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS=$(aws apprunner describe-service \
              --service-arn ${{ env.APP_RUNNER_SERVICE }} \
              --query "Service.Status" \
              --output text)
              
            echo "Current service status: $STATUS"
            
            if [ "$STATUS" = "RUNNING" ]; then
              echo "‚úÖ Deployment completed successfully!"
              break
            fi
            
            if [ "$STATUS" = "CREATE_FAILED" ] || [ "$STATUS" = "DELETE_FAILED" ] || [ "$STATUS" = "UPDATE_FAILED" ]; then
              echo "‚ùå Deployment failed with status: $STATUS"
              exit 1
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            echo "Waiting for deployment to complete... Attempt $ATTEMPT of $MAX_ATTEMPTS"
            sleep $SLEEP_TIME
          done
          
          if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
            echo "‚ùå Deployment timed out after $(($MAX_ATTEMPTS * $SLEEP_TIME)) seconds"
            exit 1
          fi
          
      - name: Update PR with Deployment Status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `### üöÄ App Runner Deployment Status - ${{ env.ENVIRONMENT }}
            #### Deployment Details
            | Status | Description |
            |--------|-------------|
            | üè∑Ô∏è Service | \`${{ env.APP_RUNNER_SERVICE }}\` |
            | üîñ Deployment ID | \`${{ steps.deploy-apprunner.outputs.deploymentId }}\` |
            | üèóÔ∏è Branch | \`${process.env.GITHUB_HEAD_REF}\` |
            | üåç Environment | \`${{ env.ENVIRONMENT }}\` |
            
            #### Deployment Summary
            ‚úÖ Successfully deployed to AWS App Runner
            
            *Deployed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });