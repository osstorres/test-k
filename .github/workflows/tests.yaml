name: "Tests ðŸ”¬"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    paths:
      - 'app/**'
      - 'tests/**'
      - 'pyproject.toml'
      - '.github/workflows/tests.yaml'

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  test:
    name: "Test Suite"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          uv sync --frozen --no-install-project

      - name: Run tests
        run: |
          mkdir -p coverage
          uv run pytest \
            --cov-report=html:coverage/cov.html \
            --cov-report=xml:coverage/cov.xml \
            --junit-xml=test-report.xml

      - name: Test Report
        uses: mikepenz/action-junit-report@v5
        if: success() || failure()
        with:
          report_paths: 'test-report.xml'
          check_name: 'Test Report'
          fail_on_failure: false
          require_tests: false

      - name: Coverage Report
        if: success() || failure()
        run: |
          if [ -f coverage/cov.xml ]; then
            echo "## ðŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Coverage report generated successfully." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "View detailed coverage in the artifacts or run locally:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "uv run pytest --cov=app --cov-report=html:coverage/cov.html" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage/cov.xml
            coverage/cov.html
          retention-days: 7

      - name: Comment PR with test results
        if: github.event_name == 'pull_request' && (success() || failure())
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let summary = '## ðŸ”¬ Test Results\n\n';
            
            try {
              const testReportPath = 'test-report.xml';
              if (fs.existsSync(testReportPath)) {
                const testReport = fs.readFileSync(testReportPath, 'utf8');
                const testsMatch = testReport.match(/tests="(\d+)" failures="(\d+)" errors="(\d+)" skipped="(\d+)"/);
                if (testsMatch) {
                  const total = parseInt(testsMatch[1]);
                  const failed = parseInt(testsMatch[2]) + parseInt(testsMatch[3]);
                  const skipped = parseInt(testsMatch[4]);
                  const passed = total - failed - skipped;
                  
                  summary += `### Test Summary\n\n`;
                  summary += `| Status | Count |\n`;
                  summary += `|--------|-------|\n`;
                  summary += `| âœ… Passed | ${passed} |\n`;
                  summary += `| âŒ Failed | ${failed} |\n`;
                  summary += `| âšª Skipped | ${skipped} |\n`;
                  summary += `| ðŸ“Š Total | ${total} |\n\n`;
                }
              }
            } catch (error) {
              console.log('Could not parse test report:', error);
            }
            
            try {
              const coveragePath = 'coverage/cov.xml';
              if (fs.existsSync(coveragePath)) {
                const coverageReport = fs.readFileSync(coveragePath, 'utf8');
                const coverageMatch = coverageReport.match(/line-rate="([\d.]+)"/);
                if (coverageMatch) {
                  const coverage = parseFloat(coverageMatch[1]) * 100;
                  summary += `### Coverage\n\n`;
                  summary += `**${coverage.toFixed(2)}%** code coverage\n\n`;
                }
              }
            } catch (error) {
              console.log('Could not parse coverage report:', error);
            }
            
            summary += `---\n`;
            summary += `*Generated by GitHub Actions*`;
            
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(
              comment => comment.user.type === 'Bot' && comment.body.includes('ðŸ”¬ Test Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }

